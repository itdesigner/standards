<!DOCTYPE html>
<html>
    <head>
        <title>Engineering Standards : AWS Security Primer</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Engineering Standards</a></span>
                            </li>
                                                    <li>
                                <span><a href="33470365.html">Engineering Standards &amp; Best Practices</a></span>
                            </li>
                                                    <li>
                                <span><a href="AWS_33474897.html">AWS</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Engineering Standards : AWS Security Primer
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Jerry Shaughnessy</span> on Oct 28, 2017
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p style="">Let me summarize how AWS Security works to make sure you are not surprised one day.</p><h2 style="" id="AWSSecurityPrimer-AccountStructure">Account Structure</h2><p style=""><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image fr-fin fr-dib confluence-external-resource image-center" src="https://cloudonaut.io/images/2017/05/aws-security-surface-account-structure.png" data-image-src="https://cloudonaut.io/images/2017/05/aws-security-surface-account-structure.png"></span></p><p style="">In 2016, AWS released Organizations. An Organization is a bucket for multiple AWS Accounts. The key thing to consider is Service Control Policies (SCPs). SCPs are evaluated before IAM policies. So you can restrict usage of services within an AWS account and no IAM policy in the world can change that.</p><p style="">The security best practices for root user rules still apply:</p><ol style=""><li>Don’t use your root user.</li><li>Activate MFA.</li><li>Don’t use the Access Key.</li></ol><h2 style="" id="AWSSecurityPrimer-AWSAPI">AWS API</h2><p style="">I needed to separate this topic into two: Authentication (who you are) and Authorization (what you are allowed to do).</p><h3 style="" id="AWSSecurityPrimer-Authentication">Authentication</h3><p style=""><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image fr-fin fr-dib confluence-external-resource image-center" src="https://cloudonaut.io/images/2017/05/aws-security-surface-api-authentication.png" data-image-src="https://cloudonaut.io/images/2017/05/aws-security-surface-api-authentication.png"></span></p><p style="">The thing you are familiar with is the <strong>IAM User</strong>. If you don’t use the root user (which you should not), you are most likely using AWS with IAM Users. An IAM User can (this is optional!) login to the Management Console using a Login Profile. As you know, the password should not be as trivial as your birthday, which you can enforce with a password policy. It’s also regarded as a good practice to activate MFA for all IAM Users with a Login Profile. If you want to use the AWS CLI, you also need an Access Key which you download to your laptop. This is very sensitive information, and it’s a good practice to rotate this Access Key in regular intervals. If you are using AWS CodeCommit (managed git repo) then you also can upload your public SSH key for authentication purposes. A lot of stuff, still we have not talked about what the user is allowed to do. This will be covered in the next section.</p><p style="">But, let’s first look at other points on the map.</p><ul style=""><li>An <strong>IAM Group</strong> is not an identity (you cannot reference the group later) it just groups IAM Users. And you can manage Authorization for the whole group instead of individual users, which is also a good practice.</li><li><strong>Cognito</strong> is niche. You can manage your own pools of users (not IAM Users) or connect with Facebook, Twitter, etc., and all those users can (depends on what you authorize) get access to parts (or the whole) of your AWS account.</li><li>An <strong>EC2 Instance Profile</strong> is used to authenticate an <strong>EC2 Instance</strong>. This is handy if your EC2 instances want to communicate with the AWS API. No need for Access Keys on your EC2 instances.</li><li><strong>Federation</strong> can make your life easier if you have many users that want to use AWS in your company. You can use an external Identity Provider such as your AD to authenticate users.</li><li>An <strong>IAM Role</strong> can only be assumed. You cannot log in. The cool thing is that not only IAM Users can assume roles. Also, AWS services can assume roles for you to work on your behalf. Even roles can assume roles, which is amazing if you plan to complicate your setup. An important point to keep in mind is that a role controls who can assume this role in a <strong>Trust Policy</strong>.</li><li>To make things simpler, AWS introduced <strong>Service-Linked Roles</strong>. Some AWS services manage parts of your AWS account on your behalf. e.g. EMR launches EC2 instances to run Hadoop for you. Before Service-Linked Roles, you had to create an IAM Role with the proper Trust Policy for AWS to work in your account. Service-Linked Roles come pre-configured and are managed by AWS. You only have to install them once.</li><li>Also kind of niche is <strong>IoT Things</strong>. Things like your thermostat authenticate with a certificate. A thing can (depends on what you authorize) get access to parts (or the whole) of your AWS account.</li></ul><p style="">This is a summary of who can get access to your AWS account.</p><h3 style="" id="AWSSecurityPrimer-Authorization">Authorization</h3><p style=""><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image fr-fin fr-dib confluence-external-resource image-center" src="https://cloudonaut.io/images/2017/05/aws-security-surface-api-authorization.png" data-image-src="https://cloudonaut.io/images/2017/05/aws-security-surface-api-authorization.png"></span></p><p style="">Given that you, or a thing, or a machine, … authenticated successfully, you/they now want to do something. That’s where <strong>IAM Policies</strong> come into play. A policy can be defined inline (IAM User, IAM Group, IAM Role) or can be a separate entity (<strong>Managed Policy</strong>) that can be attached to IAM Users, IAM Groups, or IAM Roles. You can either create your own Managed Policies or use the predefined policies managed by AWS. You will most likely not follow the principle of least privileges if you use AWS managed policies. The whole policy topic seems easy to understand. The only problem is defining those policies. That’s why I created the <a style="" href="https://iam.cloudonaut.io/" rel="nofollow" class="external-link">Complete AWS IAM Reference</a>.</p><p style="">Besides IAM Policies, some services use additional authorization mechanisms. The services with their own authorization mechanism are:</p><ul style=""><li><strong>SNS</strong> and <strong>SQS</strong>: A <strong>Topic Policy</strong> or <strong>Queue Policy</strong> can open a topic/queue to things like IAM User, IAM Role, AWS Account, or just all of us. This can be handy, but you should think twice before doing so. Most likely, you can use the assume role approach to achieve the same thing!</li><li><strong>Glacier</strong>: Glacier comes with two types of policies, one to control access, and the other to control the modification of archives. The latter is important if you have to enforce that data can not be changed for legal reasons.</li><li><strong>IoT</strong>: As mentioned, IoT Things can authenticate, and the <strong>Policy</strong> determines what they can do in your AWS account.</li><li><strong>Lambda</strong>: A <strong>Lambda Function</strong> can be opened for invocation by a <strong>Permission</strong>. This is needed if you want a “Cron” to trigger your Lambda because this “Cron” is AWS. So AWS needs permissions to invoke your function. Most likely, you can use the assume role approach to achieve the same end!</li><li><strong>S3</strong>: S3 is the king of alternative ways for authorization.<ul><li>You can set <strong>ACLs</strong><span> </span>on the bucket and object level to give read/write permissions. I recommend not using them. There is no simple way to change all ACLs on the object level. And it is very hard to reason about if every object has different permissions.</li><li>You can also use a <strong>Bucket Policy</strong> to give read/write permissions to your bucket/objects. This makes sense if your bucket is public and you want to give read access to the world.</li><li>You can also generate pre-signed URLs to give temporary permissions to read or upload objects. This makes sense if you want users to directly upload files from their browser.</li></ul></li><li><strong>KMS</strong>: <strong>Key Policies</strong> are the primary way to control access to customer master keys (CMKs) in KMS. On top of that, you can use IAM policies to authorize CMKs. The second way to control access is <strong>Grants</strong>. With a Grant, you can allow another AWS principal (e.g. an AWS account) to use a CMK with some restrictions. You could also implement this with the Key policy, but grants are more flexible to control.</li></ul><h2 style="" id="AWSSecurityPrimer-ServiceAPI">Service API</h2><p style=""><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image fr-fin fr-dib confluence-external-resource image-center" src="https://cloudonaut.io/images/2017/05/aws-security-surface-service-api.png" data-image-src="https://cloudonaut.io/images/2017/05/aws-security-surface-service-api.png"></span></p><p style="">Some services come with their own API. Databases, like MySQL, come with their own authentication and authorization mechanism. You usually authenticate with a username and password and the database user is authorized to do specific things (e.g. not <code>DROP TABLE</code>). Keep in mind that the AWS API to manage RDS still uses the AWS API auth mechanism.</p><p style="">If you want to administer your Linux or Windows virtual machine you will use SSH or RDP. For Linux machines, AWS can deploy up to one public SSH key to your instance. You can then log in via SSH with the private key on your machine. For Windows machines, AWS encrypts the password with the public key, and you can use the private key to decrypt the password. Using the username and password, you can log in via RDP.</p><h2 style="" id="AWSSecurityPrimer-Network">Network</h2><p style=""><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image fr-fin fr-dib confluence-external-resource image-center" src="https://cloudonaut.io/images/2017/05/aws-security-surface-network.png" data-image-src="https://cloudonaut.io/images/2017/05/aws-security-surface-network.png"></span></p><p style="">The network is where many AWS customers spend most of their time when thinking about security. But as you can see, it is much easier to understand than AWS API access. You create a VPC (no EC2-classic coverage here!) where you define your subnets. Subnets within a VPC can talk to each other (they are routed).</p><p style="">The recommended way of controlling network access is <strong>Security Groups</strong>. A Security Group is attached to ENIs (network interfaces) and controls inbound and outbound traffic. By default, Security Groups do not allow any inbound traffic but allow all outbound traffic. Besides identifying traffic by IP address ranges, you can also identify traffic by the target/origin Security Groups. Security Groups are stateful: if an inbound packet is allowed, the response is also allowed and vice versa.</p><p style="">There are also <strong>ACLs</strong><span> </span>to control inbound and outbound traffic for subnets. By default, ACLs are configured to allow all inbound and outbound traffic. ACLs are stateless, so you will most likely open all high ports. I recommend not using ACLs unless you have a reason.</p><p style="">Finally, you can control who can talk to whom on the network by configuring routes. You may want to connect your office network with your VPC. You can use a VPN connection to do so. The routing then determines which Subnets can send packages to your office and vice versa.</p><h2 style="" id="AWSSecurityPrimer-DataEncryption">Data Encryption</h2><p style=""><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image fr-fin fr-dib confluence-external-resource image-center" src="https://cloudonaut.io/images/2017/05/aws-security-surface-data-encryption.png" data-image-src="https://cloudonaut.io/images/2017/05/aws-security-surface-data-encryption.png"></span></p><p style="">Mostly all services that store data (EBS, S3, SQS, etc.) support encryption at rest. Which means that AWS will encrypt the data on-disk. This is handy if you (or your regulator) fears that another AWS customer could get access to your data because of the shared nature of the environment, e.g. if you return an EBS volume to AWS because you no longer need it, the underlying hard disk will be reused. AWS wipes the data but there is a very tiny chance that someone with big resources can reconstruct parts of the data. If you don’t trust AWS, you should encrypt the data before you send it to the service or not use AWS at all.</p><blockquote style="text-align: center;"><p>Spoiler: I’m not an expert on Data Encryption!</p></blockquote><p style="">When data is encrypted/decrypted a key/secret is needed. Those keys are managed by the <strong>Key Management Service</strong> (KMS). The way this works is that KMS owns the customer master key (CMK) and issues data keys that are then used by, for example, EBS to encrypt/decrypt the data. The data key is stored together with the encrypted data, and is also encrypted. When EBS wants to decrypt the data again (because you want to read it), it sends the encrypted data key to KMS, where the master key can decrypt the data key. The decrypted data key is returned to EBS where it is used to decrypt the data. The key is that the CMK never leaves KMS. If you delete the CMK, the encrypted data is garbage because it can no longer be decrypted.</p><p style="">If you don’t want AWS to own/know your master key, you can use a magic box called <a style="" href="https://en.wikipedia.org/wiki/Hardware_security_module" rel="nofollow" class="external-link">Hardware Security Module</a> to manage your master key. CloudHSM provides this box to you as a Service for ~$20,000 per year. The trick is that this magic hardware box audits access and destroys itself if someone wants to open it. The magic box also handles the encryption/decryption part on its own hardware.</p><p style="">To make things easier again, data that is in transit also wants to be encrypted. Especially if this data travels through the Internet. All AWS services that can expose HTTP endpoints (ELB, ALB, CloudFront, API Gateway) also support TLS/SSL encryption with certificates managed by the <strong>Certificate Manager</strong> which renews certificates automatically at no cost.</p><p style="">If you want to connect your office with your VPC, you can use a VPN tunnel to encrypt the data.<br/>The AWS API is also encrypting traffic using TSL/SSL.</p><p style="">The open question is: What happens if you talk to your database from an EC2 instance? Or if you talk to your Application Servers. You should at least know which traffic is (not) encrypted and why.</p><h2 style="" id="AWSSecurityPrimer-Governance">Governance</h2><p style=""><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image fr-fin fr-dib confluence-external-resource image-center" src="https://cloudonaut.io/images/2017/05/aws-security-surface-governance.png" data-image-src="https://cloudonaut.io/images/2017/05/aws-security-surface-governance.png"></span></p><p style="">Documentation is king. You write down all your security related rules in Confluence. The first point in your list: Activate MFA. A year later, you recognize that still half of your IAM Users have not activated MFA. Maybe you need something better?</p><ul style=""><li>AWS provides a service to record<span> </span><del>all (okay, this was marketing speak)<span> </span></del> for most of the API calls using <strong>CloudTrail</strong>. With this tool, you can know exactly who did what and when. You can also use Lambda to analyze this in near real time (5 minutes) and send an alert if a user deactivates MFA.</li><li><strong>AWS Config</strong> creates snapshots of all your AWS configurations where you can define rules that must be met.</li><li><strong>Trusted Advisor</strong> checks if you follow best practices. Make sure that you receive those emails and review the findings every week!</li><li><strong>VPC Flow Logs</strong> can record network flows in your VPC. You could analyze them to: <a style="" href="https://cloudonaut.io/improve-security-groups-using-vpc-flow-logs-aws-config/" rel="nofollow" class="external-link">Improve Security (Groups) using VPC Flow Logs &amp; AWS Config</a></li></ul><h2 style="" id="AWSSecurityPrimer-Summary">Summary</h2><p style="">This was a high-level overview of the AWS Security surface. From my experience, customers spend most of their time securing their network because they know how to do this. I recommend that you shift your resources a little bit to make sure you get the AWS API Security right. With a single S3 Bucket Policy you can confidently open your data to the world.</p><p style="">I missed a few points. Some of them are already well-known:</p><ul style=""><li>Patching the operating system (AMI).</li><li>Patching the application’s dependencies.</li><li>Application internals (e.g. input validation).</li></ul>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Oct 29, 2017 01:41</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
